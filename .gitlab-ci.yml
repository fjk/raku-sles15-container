stages:
  - build
  - test
  - package
  - release

variables:
  IMAGE_NAME: "raku-sles15sp6"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: "tcp://docker:2375"

# -------------------------------------------------------------------
# Stage 1: Image bauen und als image.tar speichern
# -------------------------------------------------------------------
build-image:
  stage: build
  image: docker:24.0
  services:
    - docker:24.0-dind
  script:
    - echo "Building container image..."
    - docker build -t "${IMAGE_NAME}:${CI_COMMIT_SHA}" -f Containerfile .
    - echo "Saving image to image.tar..."
    - docker save -o image.tar "${IMAGE_NAME}:${CI_COMMIT_SHA}"
  artifacts:
    paths:
      - image.tar
    expire_in: 1 week

# -------------------------------------------------------------------
# Stage 2a: Raku-Version testen
# -------------------------------------------------------------------
test-raku:
  stage: test
  needs: ["build-image"]
  image: docker:24.0
  services:
    - docker:24.0-dind
  script:
    - echo "Loading image.tar..."
    - docker load -i image.tar
    - echo "Testing Raku..."
    - docker run --rm "${IMAGE_NAME}:${CI_COMMIT_SHA}" raku -v

# -------------------------------------------------------------------
# Stage 2b: Module aus modules.conf testen
# -------------------------------------------------------------------
test-modules:
  stage: test
  needs: ["build-image"]
  image: docker:24.0
  services:
    - docker:24.0-dind
  script:
    - |
      if [ ! -f modules.conf ]; then
        echo "No modules.conf — skipping tests."
        exit 0
      fi

      echo "Loading image.tar..."
      docker load -i image.tar

      echo "Testing Raku modules from modules.conf..."
      while read -r mod; do
        # Skip empty and commented lines
        [ -z "$mod" ] && continue
        case "$mod" in
          \#*) continue ;;
        esac

        echo "  -> use $mod"

        if [ "$mod" = "Cro::HTTP" ]; then
          docker run --rm "${IMAGE_NAME}:${CI_COMMIT_SHA}" \
            raku -e "use Cro::HTTP::Router; use Cro::HTTP::Server; use Cro::HTTP::Log::File; say 'OK: Cro HTTP stack';"
        else
          docker run --rm "${IMAGE_NAME}:${CI_COMMIT_SHA}" \
            raku -e "use $mod; say \"OK: $mod\";"
        fi
      done < modules.conf

# -------------------------------------------------------------------
# Stage 3: Package – Runtime + Container-Tarball erzeugen (nur für Tags)
# -------------------------------------------------------------------
package:
  stage: package
  needs: ["build-image"]
  image: docker:24.0
  services:
    - docker:24.0-dind
  rules:
    - if: $CI_COMMIT_TAG     # nur für Tags laufen
  script:
    - mkdir -p build
    - echo "Loading image.tar..."
    - docker load -i image.tar

    # Tag innerhalb der Pipeline (z.B. raku-sles15sp6:v0.0.3)
    - echo "Tagging image for release tag ${CI_COMMIT_TAG}..."
    - docker tag "${IMAGE_NAME}:${CI_COMMIT_SHA}" "${IMAGE_NAME}:${CI_COMMIT_TAG}"

    - echo "Saving container image to tarball..."
    - docker save -o "build/${IMAGE_NAME}-${CI_COMMIT_TAG}.tar" "${IMAGE_NAME}:${CI_COMMIT_TAG}"

    - echo "Extracting Raku runtime from container..."
    - |
      docker run --rm "${IMAGE_NAME}:${CI_COMMIT_TAG}" sh -lc '
        set -e
        cd /root/.rakubrew
        current_line=$(/root/.rakubrew/bin/rakubrew current)
        current=$(echo "$current_line" | awk "{print \$NF}")
        echo "Detected runtime: $current" >&2
        cd versions
        tar czf - "$current"
      ' > "build/raku-runtime-${CI_COMMIT_TAG}.tar.gz"

  artifacts:
    paths:
      - build/
    expire_in: 1 month

# -------------------------------------------------------------------
# Stage 4: Release – GitLab Release + Links zu Artefakten
# -------------------------------------------------------------------
release:
  stage: release
  needs: ["package"]
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Creating GitLab Release for ${CI_COMMIT_TAG}..."
  release:
    name: "Release $CI_COMMIT_TAG"
    tag_name: "$CI_COMMIT_TAG"
    description: |
      Automated release for Raku SLES runtime.

      Includes:
       - Container image tarball
       - Portable Raku runtime tarball
    assets:
      links:
        - name: "Container image tarball"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/build/${IMAGE_NAME}-${CI_COMMIT_TAG}.tar"
        - name: "Portable Raku runtime"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/build/raku-runtime-${CI_COMMIT_TAG}.tar.gz"