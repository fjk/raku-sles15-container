stages:
  - build
  - test
  - package
  - release

# Gemeinsame Variablen (werden bei Jobs Ã¼berschrieben, wenn nÃ¶tig)
variables:
  IMAGE_NAME: "raku-sles15sp6"

# ===============================================================
# ðŸŸ£ Pipeline fÃ¼r gitlab.com  (docker:dind, volle 4 Stages)
# ===============================================================

# --- Stage 1: Image bauen und als image.tar speichern ----------
build-image-gitlabcom:
  stage: build
  image: docker:24.0
  services:
    - docker:24.0-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
  rules:
    - if: '$CI_SERVER_HOST == "gitlab.com"'
  script:
    - echo "Building container image (gitlab.com)..."
    - docker build -t "${IMAGE_NAME}:${CI_COMMIT_SHA}" -f Containerfile .
    - echo "Saving image to image.tar..."
    - docker save -o image.tar "${IMAGE_NAME}:${CI_COMMIT_SHA}"
  artifacts:
    paths:
      - image.tar
    expire_in: 1 week

# --- Stage 2a: Raku-Version testen -----------------------------
test-raku-gitlabcom:
  stage: test
  needs: ["build-image-gitlabcom"]
  image: docker:24.0
  services:
    - docker:24.0-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
  rules:
    - if: '$CI_SERVER_HOST == "gitlab.com"'
  script:
    - echo "Loading image.tar..."
    - docker load -i image.tar
    - echo "Testing Raku..."
    - docker run --rm "${IMAGE_NAME}:${CI_COMMIT_SHA}" raku -v

# --- Stage 2b: Module aus modules.conf testen ------------------
test-modules-gitlabcom:
  stage: test
  needs: ["build-image-gitlabcom"]
  image: docker:24.0
  services:
    - docker:24.0-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
  rules:
    - if: '$CI_SERVER_HOST == "gitlab.com"'
  script: |
    if [ ! -f modules.conf ]; then
      echo "No modules.conf â€” skipping tests."
      exit 0
    fi

    echo "Loading image.tar..."
    docker load -i image.tar

    echo "Testing Raku modules from modules.conf..."
    while read -r mod; do
      # Skip empty and commented lines
      [ -z "$mod" ] && continue
      case "$mod" in
        \#*) continue ;;
      esac

      echo "  -> use $mod"

      if [ "$mod" = "Cro::HTTP" ]; then
        docker run --rm "${IMAGE_NAME}:${CI_COMMIT_SHA}" \
          raku -e "use Cro::HTTP::Router; use Cro::HTTP::Server; use Cro::HTTP::Log::File; say 'OK: Cro HTTP stack';"
      else
        docker run --rm "${IMAGE_NAME}:${CI_COMMIT_SHA}" \
          raku -e "use $mod; say \"OK: $mod\";"
      fi
    done < modules.conf

# --- Stage 3: Package â€“ Runtime + Container-Tarball (nur Tags) -
package-gitlabcom:
  stage: package
  needs: ["build-image-gitlabcom"]
  image: docker:24.0
  services:
    - docker:24.0-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
  rules:
    - if: '$CI_SERVER_HOST == "gitlab.com" && $CI_COMMIT_TAG'
  script:
    - mkdir -p build
    - echo "Loading image.tar..."
    - docker load -i image.tar

    # Tag innerhalb der Pipeline (z.B. raku-sles15sp6:v0.0.3)
    - echo "Tagging image for release tag ${CI_COMMIT_TAG}..."
    - docker tag "${IMAGE_NAME}:${CI_COMMIT_SHA}" "${IMAGE_NAME}:${CI_COMMIT_TAG}"

    - echo "Saving container image to tarball..."
    - docker save -o "build/${IMAGE_NAME}-${CI_COMMIT_TAG}.tar" "${IMAGE_NAME}:${CI_COMMIT_TAG}"

    - echo "Extracting Raku runtime from container..."
    - |
      docker run --rm "${IMAGE_NAME}:${CI_COMMIT_TAG}" sh -lc '
        set -e
        cd /root/.rakubrew
        current_line=$(/root/.rakubrew/bin/rakubrew current)
        current=$(echo "$current_line" | awk "{print \$NF}")
        echo "Detected runtime: $current" >&2
        cd versions
        tar czf - "$current"
      ' > "build/raku-runtime-${CI_COMMIT_TAG}.tar.gz"
  artifacts:
    paths:
      - build/
    expire_in: 1 month

# --- Stage 4: Release â€“ GitLab Release (nur Tags auf gitlab.com)
release-gitlabcom:
  stage: release
  needs: ["package-gitlabcom"]
  image: alpine:latest
  rules:
    - if: '$CI_SERVER_HOST == "gitlab.com" && $CI_COMMIT_TAG'
  script:
    - echo "Creating GitLab Release for ${CI_COMMIT_TAG} on gitlab.com..."
  release:
    name: "Release $CI_COMMIT_TAG"
    tag_name: "$CI_COMMIT_TAG"
    description: |
      Automated release for Raku SLES runtime (gitlab.com).

      Includes:
       - Container image tarball
       - Portable Raku runtime tarball
    assets:
      links:
        - name: "Container image tarball"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/build/${IMAGE_NAME}-${CI_COMMIT_TAG}.tar"
        - name: "Portable Raku runtime"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/build/raku-runtime-${CI_COMMIT_TAG}.tar.gz"

# ===============================================================
# ðŸ”µ Pipeline fÃ¼r code.siemens.com  (podman in Leap-Image)
#    â†’ nur build + test, keine Releases (erstmal)
# ===============================================================

build-image-siemens:
  stage: build
  image: registry.opensuse.org/opensuse/leap:15.6
  rules:
    - if: '$CI_SERVER_HOST == "code.siemens.com"'
  script:
    - echo "Building container image (code.siemens.com, podman)..."
    - zypper -n ref
    - zypper -n in --no-recommends podman
    - podman build -t "${IMAGE_NAME}:${CI_COMMIT_SHA}" -f Containerfile .
    - echo "Saving image to image.tar..."
    - podman save -o image.tar "${IMAGE_NAME}:${CI_COMMIT_SHA}"
  artifacts:
    paths:
      - image.tar
    expire_in: 1 week

test-raku-siemens:
  stage: test
  needs: ["build-image-siemens"]
  image: registry.opensuse.org/opensuse/leap:15.6
  rules:
    - if: '$CI_SERVER_HOST == "code.siemens.com"'
  script:
    - echo "Loading image.tar (podman)..."
    - zypper -n ref
    - zypper -n in --no-recommends podman
    - podman load -i image.tar
    - echo "Testing Raku in Siemens CI..."
    - podman run --rm "${IMAGE_NAME}:${CI_COMMIT_SHA}" raku -v
    